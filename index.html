<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Logger</title>
    <!-- Add manifest.json for PWA functionality -->
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            width: 100vw;
            height: 100vh;
        }
        video, canvas {
            max-width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
            background-color: #000;
        }
        .button-shadow {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
        }
        #message-modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .message-box {
            background-color: #2D2D2D;
            border: 1px solid #444;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="container flex flex-col items-center justify-center p-4 space-y-4">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-center">Video Logger</h1>
        <div class="relative w-full max-w-2xl">
            <!-- Video element to capture the stream -->
            <video id="video-stream" class="hidden w-full h-auto"></video>
            <!-- Canvas element to draw the video and overlays -->
            <canvas id="video-canvas" class="w-full aspect-[4/3] sm:aspect-video"></canvas>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 w-full max-w-2xl">
            <button id="start-stop-btn"
                    class="w-full sm:w-1/2 p-4 rounded-full text-lg font-medium transition-all duration-300 button-shadow
                           bg-green-600 hover:bg-green-700 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                Start Recording
            </button>
            <button id="toggle-camera-btn"
                    class="w-full sm:w-1/2 p-4 rounded-full text-lg font-medium transition-all duration-300 button-shadow
                           bg-gray-600 hover:bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M12 8c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    <path d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-4 7h8v2h-8v-2z"/>
                </svg>
                <span>Flip Camera</span>
            </button>
            <a id="download-link" href="#" download="recorded-video.webm"
               class="w-full sm:w-1/2 p-4 text-center rounded-full text-lg font-medium transition-all duration-300 button-shadow
                      bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 hidden">
                Download Video
            </a>
        </div>
        <div id="status-message" class="mt-4 text-center text-sm sm:text-base text-gray-400">
            Initializing camera and location...
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="message-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="message-box p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-300 text-sm"></p>
            <div class="mt-4 flex justify-end">
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Log level for Firebase debugging, but not used in this app since we don't use Firestore
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug');

        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('video-canvas');
        const context = canvas.getContext('2d');
        const startStopBtn = document.getElementById('start-stop-btn');
        const toggleCameraBtn = document.getElementById('toggle-camera-btn');
        const downloadLink = document.getElementById('download-link');
        const statusMessage = document.getElementById('status-message');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        let mediaRecorder;
        let recordedChunks = [];
        let videoStream;
        let geolocationWatcher;
        let lat = null;
        let lon = null;
        let recording = false;
        let animationFrameId;
        let facingMode = 'user'; // 'user' for front camera, 'environment' for back

        // Utility function to show a custom modal instead of alert()
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        modalOkBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Set up video and canvas to have the same aspect ratio
        function setCanvasDimensions() {
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                const aspectRatio = video.videoWidth / video.videoHeight;
                const canvasWidth = canvas.clientWidth;
                canvas.width = canvasWidth;
                canvas.height = canvasWidth / aspectRatio;
            }
        }

        // Main animation loop to draw video, timestamp, and GPS data on the canvas
        function drawFrame() {
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                setCanvasDimensions();
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Add timestamp
                const now = new Date();
                const timestampText = now.toLocaleString();
                context.font = 'bold 20px Inter, sans-serif';
                context.fillStyle = 'rgba(0, 0, 0, 0.5)';
                context.fillRect(10, canvas.height - 40, context.measureText(timestampText).width + 20, 30);
                context.fillStyle = 'white';
                context.fillText(timestampText, 20, canvas.height - 20);

                // Add GPS coordinates
                if (lat !== null && lon !== null) {
                    const gpsText = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
                    context.font = 'bold 20px Inter, sans-serif';
                    context.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    context.fillRect(10, canvas.height - 80, context.measureText(gpsText).width + 20, 30);
                    context.fillStyle = 'white';
                    context.fillText(gpsText, 20, canvas.height - 60);
                }
            }
            animationFrameId = requestAnimationFrame(drawFrame);
        }

        // Get video stream and start the drawing loop
        async function getVideoStream() {
            // Stop existing stream if it exists
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }

            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode }, // Use the current facingMode
                    audio: true
                });
                video.srcObject = videoStream;
                video.onloadedmetadata = () => {
                    video.play();
                    requestAnimationFrame(drawFrame);
                };
                statusMessage.textContent = "Ready to record.";
            } catch (err) {
                console.error("Error accessing video stream:", err);
                statusMessage.textContent = "Error: Camera access denied or not available.";
                showModal('Camera Access Denied', 'Please allow camera access to use this application.');
            }
        }

        // Get live GPS coordinates
        function startGeolocationWatcher() {
            if ("geolocation" in navigator) {
                geolocationWatcher = navigator.geolocation.watchPosition(
                    (position) => {
                        lat = position.coords.latitude;
                        lon = position.coords.longitude;
                        statusMessage.textContent = `GPS Data: Lat ${lat.toFixed(5)}, Lon ${lon.toFixed(5)}`;
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let errorMessage = "Unable to get location data. Please enable location services.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Location access was denied. Please grant permission in your browser settings.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Location information is unavailable. This may be due to a poor signal.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "The request to get user location timed out.";
                        }
                        statusMessage.textContent = "Geolocation disabled or unavailable.";
                        showModal('Geolocation Error', errorMessage);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                statusMessage.textContent = "Geolocation is not supported by your browser.";
                showModal('Geolocation Not Supported', 'Your browser does not support location services.');
            }
        }

        startStopBtn.addEventListener('click', () => {
            if (!recording) {
                // Start recording
                const canvasStream = canvas.captureStream(30); // 30 FPS
                mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm' });
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoURL = URL.createObjectURL(blob);
                    downloadLink.href = videoURL;
                    downloadLink.classList.remove('hidden');
                    startStopBtn.classList.remove('hidden');
                    showModal('Recording Complete', 'Your video has been saved! You can download it now.');
                    stopRecording();
                };

                mediaRecorder.start();
                recording = true;
                startStopBtn.textContent = "Stop Recording";
                startStopBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                startStopBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                downloadLink.classList.add('hidden');
                statusMessage.textContent = "Recording...";
            } else {
                // Stop recording
                mediaRecorder.stop();
                recording = false;
                startStopBtn.textContent = "Processing...";
                startStopBtn.classList.add('hidden');
            }
        });

        toggleCameraBtn.addEventListener('click', () => {
            if (recording) {
                showModal('Cannot Switch Camera', 'Please stop the current recording before switching cameras.');
                return;
            }
            // Toggle the camera mode
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            getVideoStream();
        });


        function stopRecording() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            if (geolocationWatcher) {
                navigator.geolocation.clearWatch(geolocationWatcher);
            }
        }

        // PWA Setup
        // This dynamically creates the manifest file and registers the service worker
        window.onload = function() {
            // Dynamically create a manifest.json file
            const manifest = {
                "name": "Video Logger",
                "short_name": "VideoLogger",
                "description": "A simple video recorder with timestamp and GPS data.",
                "start_url": "./",
                "display": "standalone",
                "background_color": "#121212",
                "theme_color": "#2D2D2D",
                "icons": [
                    {
                        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M18 10.48V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.48l4 3.98v-11l-4 3.98zM16 18H4V6h12v12zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z' fill='%23FFFFFF'/%3E%3C/svg%3E",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M18 10.48V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.48l4 3.98v-11l-4 3.98zM16 18H4V6h12v12zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z' fill='%23FFFFFF'/%3E%3C/svg%3E",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.querySelector('link[rel="manifest"]').href = manifestUrl;

            // Register the service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(
                    'data:application/javascript;base64,' + btoa(
                        'self.addEventListener("fetch", function(event) {});'
                    )
                ).then(function(reg) {
                    console.log('Service Worker registration successful with scope: ' + reg.scope);
                }).catch(function(err) {
                    console.log('Service Worker registration failed: ' + err);
                });
            }

            getVideoStream();
            startGeolocationWatcher();
        };

        // Handle page unload to stop media tracks
        window.onbeforeunload = function() {
            stopRecording();
        };
    </script>
</body>
</html>
